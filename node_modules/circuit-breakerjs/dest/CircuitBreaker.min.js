!function(a,b){"use strict";"function"==typeof define&&define.amd?define("CircuitBreaker",["exports"],function(){a.CircuitBreaker||b(a);return a.CircuitBreaker}):b("object"==typeof exports?exports:a)}("undefined"==typeof CircuitRoot?this:CircuitRoot,function(a){"use strict";function b(a){if(!1==this instanceof b)return new b(a);this.initialize(a);return void 0}function c(a){function b(){}function c(){return e.apply(this instanceof b&&a?this:a,d.concat(Array.prototype.slice.call(arguments)))}var d,e;if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");d=Array.prototype.slice.call(arguments,1);e=this;b.prototype=this.prototype;c.prototype=new b;return c}var d={OPEN:0,HALF_OPEN:1,CLOSED:2},e={FAILURE:"failure",SUCCESS:"success",TIMEOUT:"timeout",OUTAGE:"outage"};b.prototype=function(){function a(a){if(!this.initialized){a=a||{};this.slidingTimeWindow=!isNaN(a.slidingTimeWindow)&&0<a.slidingTimeWindow?parseInt(a.slidingTimeWindow,10):3e4;this.bucketsNumber=!isNaN(a.bucketsNumber)&&0<a.bucketsNumber?parseInt(a.bucketsNumber,10):10;this.tolerance=!isNaN(a.tolerance)&&0<a.tolerance?parseInt(a.tolerance,10):50;this.calibration=!isNaN(a.calibration)&&0<a.calibration?parseInt(a.calibration,10):5;this.timeout=!isNaN(a.timeout)&&0<a.timeout?parseInt(a.timeout,10):0;this.onopen="function"==typeof a.onopen?a.onopen:function(){};this.onclose="function"==typeof a.onclose?a.onclose:function(){};this.buckets=[l.call(this)];this.state=d.CLOSED;this.initialized=!0;k.call(this)}}function b(a,b,c){if(b&&"function"!=typeof b){c=b;b=void 0}if(h.call(this)){q.call(this,b||function(){});return!1}return p.call(this,a,c)}function c(){this.forced=this.state;this.state=d.OPEN}function f(){this.forced=this.state;this.state=d.CLOSED}function g(){this.state=this.forced;this.forced=void 0}function h(){return d.OPEN===this.state}function i(){for(var a,b,c=0,d=0,f=0;f<this.buckets.length;f++){a=this.buckets[f][e.FAILURE]+this.buckets[f][e.TIMEOUT];d+=a;c+=a+this.buckets[f][e.SUCCESS]}b=d/(c>0?c:1)*100;return{total:c,error:d,percent:b}}function j(){this.timer&&clearTimeout(this.timer);n.call(this);if(this.bucketIndex>this.bucketsNumber){this.bucketIndex=0;h.call(this)&&(this.state=d.HALF_OPEN)}this.timer=setTimeout(j.bind(this),this.bucket)}function k(){this.bucketIndex=0;this.bucket=this.slidingTimeWindow/this.bucketsNumber;this.timer&&clearTimeout(this.timer);this.timer=setTimeout(j.bind(this),this.bucket)}function l(){var a={};a[e.FAILURE]=0;a[e.SUCCESS]=0;a[e.TIMEOUT]=0;a[e.OUTAGE]=0;return a}function m(){return this.buckets[this.buckets.length-1]}function n(){this.bucketIndex++;this.buckets.push(l.call(this));this.buckets.length>this.bucketsNumber&&this.buckets.shift()}function o(a,b){return function(){if(!b.done){if(b.timer){clearTimeout(b.timer);b.timer=null;delete b.timer}var c=m.call(this);c[a]++;this.forced||r.call(this);b.done=!0}}.bind(this)}function p(a,b){var c={done:!1},d=o.call(this,e.SUCCESS,c),f=o.call(this,e.FAILURE,c),g=o.call(this,e.TIMEOUT,c);b=!isNaN(b)&&b>0?parseInt(b,10):this.timeout;b>0&&(c.timer=setTimeout(g,b));try{a(d,f,g)}catch(h){f()}}function q(a){try{a()}catch(b){}var c=m.call(this);c[e.OUTAGE]++}function r(){var a=i.call(this);if(d.HALF_OPEN===this.state){var b=!m.call(this)[e.SUCCESS]&&0<a.error;if(b)this.state=d.OPEN;else{this.state=d.CLOSED;this.onclose(a)}}else{var c=a.percent>this.tolerance,f=a.total>this.calibration,g=f&&c;if(g){this.state=d.OPEN;this.onopen(a)}}}return{initialize:a,run:b,close:f,open:c,reset:g,isOpen:h,calculate:i}}();b.STATE=d;Function.prototype.bind||(Function.prototype.bind=c);a.CircuitBreaker=a.CircuitBreaker||b});