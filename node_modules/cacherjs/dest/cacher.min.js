!function(a,b){"use strict";"function"==typeof define&&define.amd?define("cacher",["exports"],function(){a.Cacher||b(a);return a.Cacher}):b("object"==typeof exports?exports:a)}("undefined"==typeof CacherRoot?this:CacherRoot,function(a){"use strict";function b(a){if(!1==this instanceof b)return new b(a);this.initialize(a)}b.MAX_STRATEGY={NO_ADD:0,CLOSEST_TTL:1};b.prototype=function(){function a(a){function c(a,b){d.nostore=!0;e.call(d,b.key,b.value,b.ttl);delete d.nostore}var d=this,f=!1,g=0;if(!this.initialized){a=a||{};this.cache={};this.length=0;this.maxStrategy=a.maxStrategy||b.MAX_STRATEGY.NO_ADD;this.max=a.max&&!isNaN(a.max)&&0<a.max?parseInt(a.max,10):0;this.ttl=a.ttl&&!isNaN(a.ttl)&&0<a.ttl?parseInt(a.ttl,10):0;this.interval=a.interval&&!isNaN(a.interval)&&0<a.interval?parseInt(a.interval,10):1e3;this.ontimeout="function"==typeof a.ontimeout?a.ontimeout:function(){};this.onkickout="function"==typeof a.onkickout?a.onkickout:function(){};this.stores=a.stores||[];for(;g<this.stores.length&&!f;){if(this.stores[g].autoload&&this.stores[g].load){f=!0;this.stores[g].load({onitem:c,oncomplete:a.oncomplete})}g++}this.initialized=!0;j.call(this)}}function c(a,b){return b?f.call(this,a):this.cache&&this.cache[a]&&this.cache[a].item}function d(a,b,d){var e=c.call(this,a,!0);return i.call(this,a,e,b,d)}function e(a,b,c,d){return i.call(this,a,b,c,d)}function f(a){var b=this.cache&&this.cache[a]&&this.cache[a].item;if(b){this.cache[a].item=null;this.cache[a].callback=null;this.cache[a].timeout=null;this.cache[a]=null;delete this.cache[a];this.length--;h.call(this,"remove",a)}return b}function g(){if(this.length)for(var a in this.cache)this.cache.hasOwnProperty(a)&&f.call(this,a)}function h(a,b,c,d){if(!this.nostore)for(var e=0;e<this.stores.length;e++)this.stores[e][a]?this.stores[e][a](b,c,d):this.stores[e].save&&this.stores[e].save({items:this.cache})}function i(a,c,d,e){var f,g;if(0===this.max||this.length<this.max||b.MAX_STRATEGY.CLOSEST_TTL===this.maxStrategy){f=d&&!isNaN(d)&&0<d?parseInt(d,10):this.ttl;this.cache[a]={item:c};this.length++;if(f){g=(new Date).getTime()+f;this.cache[a].timeout=g;this.cache[a].ttl=f}"function"==typeof e&&(this.cache[a].callback=e);h.call(this,"set",a,c,d);(f&&(this.cache[a].callback||"function"==typeof this.ontimeout||"function"==typeof this.onkickout)||this.max&&this.length>this.max)&&j.call(this,this.max&&this.length>this.max);return!0}return!1}function j(a){var b,c,e,g,h,i=0;this.timer&&clearTimeout(this.timer);if(this.length){for(var k in this.cache)if(this.cache.hasOwnProperty(k)&&this.cache[k].timeout)if(this.cache[k].timeout<=(new Date).getTime()){c=this.cache[k].item;b=this.cache[k].callback;b&&(e=b(k,c));this.ontimeout&&(g=this.ontimeout(k,c));if("object"==typeof e)d.call(this,k,e.ttl||this.cache[k].ttl,e.callback||b);else if("object"==typeof g)d.call(this,k,g.ttl||this.cache[k].ttl,g.callback||b);else if(e!==!1&&g!==!1){f.call(this,k);i++}else if(!i&&a)if(h){if(h.timeout>this.cache[k].timeout){h.key=k;h.timeout=this.cache[k].timeout}}else h={key:k,timeout:this.cache[k].timeout}}else if(!i&&a)if(h){if(h.timeout>this.cache[k].timeout){h.key=k;h.timeout=this.cache[k].timeout}}else h={key:k,timeout:this.cache[k].timeout};if(!i&&h&&this.cache[h.key]){c=this.cache[h.key].item;b=this.cache[h.key].callback;b&&b(h.key,c);this.onkickout&&this.onkickout(h.key,c);f.call(this,h.key);i++}}this.timer=setTimeout(j.bind(this),this.interval);return i}return{initialize:a,get:c,set:e,touch:d,remove:f,removeAll:g}}();a.Cacher=a.Cacher||b});